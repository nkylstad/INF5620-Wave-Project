% !TEX TS-program = pdflatex
% !TEX encoding = UTF-8 Unicode

\documentclass[11pt]{article} % use larger type; default would be 10pt
\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)

%%% PAGE DIMENSIONS
\usepackage{geometry} % to change the page dimensions
\geometry{a4paper} % or letterpaper (US) or a5paper or....
% \geometry{margin=2in} % for example, change the margins to 2 inches all round
% \geometry{landscape} % set up the page for landscape
%   read geometry.pdf for detailed page layout information
\usepackage{graphicx} % support the \includegraphics command and options
\usepackage[parfill]{parskip} % Activate to begin paragraphs with an empty line rather than an indent

%%% PACKAGES
\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float
\usepackage{amsmath}
\usepackage{fancyref}

%%% HEADERS & FOOTERS
\usepackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

%%% SECTION TITLE APPEARANCE
\usepackage{sectsty}
\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% ToC (table of contents) APPEARANCE
\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

%%% SIMPLIFIED COMMANDS:
\newcommand{\dun}{\frac{\partial u}{\partial n}}
\newcommand{\bn}{\mathbf{n}}
\newcommand{\bi}{\mathbf{i}}
\newcommand{\bj}{\mathbf{j}}
\newcommand{\Dx}{\Delta x}
\newcommand{\Dy}{\Delta y}
\newcommand{\Dt}{\Delta t}
\newcommand{\dutt}{\frac{\partial^2u}{\partial^2t}}
\newcommand{\dut}{\frac{\partial u}{\partial t}}
\newcommand{\dux}{\frac{\partial u}{\partial x}}
\newcommand{\duy}{\frac{\partial u}{\partial y}}
\newcommand{\dx}{\frac{\partial}{\partial x}}
\newcommand{\dy}{\frac{\partial}{\partial y}}
\newcommand{\unp}{u^{n+1}}
\newcommand{\un}{u^{n}}
\newcommand{\unm}{u^{n-1}}
\newcommand{\unn}{u^0}
\newcommand{\une}{u^1}
\newcommand{\half}{\frac{1}{2}}

\title{Wave Equation}
\author{The Author}
%\date{} % Activate to display a given date or no date (if empty),
         % otherwise the current date is printed 

\begin{document}
\maketitle

\section{Discretization}
We want to solve the equation
\begin{equation}
\dutt + b\dut = \dx\left(q(x,y) \dux\right) + \dy\left(q(x,y) \duy\right) + f(x,y,t)
\label{wave_eq}
\end{equation}

\subsection{The general scheme for interior points}

We use a set of approximations for the derivatives in \eqref{wave_eq}. For the second-order derivative, we use the approximation:
\begin{equation*}
\dutt \approx \frac{\unp_{i,i} - 2\un_{i,j} + \unm_{i,j}}{\Dt^2}
\end{equation*}
For the first-ordere derivative, we use the centered difference approximation:
\begin{equation*}
\dut \approx \frac{\unp_{i,i} - \unm_{i,j}}{2\Dt}
\end{equation*}
For the terms on the right-hand side of the equations, we want to evaluate the outer derivative first. We define 
\[\phi_x = q(x,y)\dux, \,\,\,\phi_y = q(x,y)\duy \]
We will adress $\phi_x$ as an example; the same process is applied to $\phi_x$. We use a centered difference approximation for the derivative of $\phi_x$. For simplicitys sake, we let $\phi =\phi_x$:
\begin{equation*}
\left[\frac{\partial\phi}{\partial x}\right]^n_{i,j} \approx \frac{\phi_{i+\half,j} - \phi_{i-\half,j}}{\Dx}
\end{equation*}
We then discretize $\phi_{i+\half,j}$ and $\phi_{i-\half,j}$:
\begin{align*}
\phi_{i+\half,j} &= q_{i+\half,j}\left[\dux\right]^n_{i+\half,j} \approx  q_{i+\half,j}\frac{\un_{i+1,j}-\un_{i,j}}{\Dx} \\
\phi_{i-\half,j} &= q_{i-\half,j}\left[\dux\right]^n_{i-\half,j} \approx  q_{i-\half,j}\frac{\un_{i,j}-\un_{i-1,j}}{\Dx} 
\end{align*}
We now combine these two to get
\begin{equation}
\left[\dx\left(q(x,y) \dux\right)\right]^n_{i,j} \approx \frac{1}{\Dx^2}\left(q_{i+\half,j}(\un_{i+1,j}-\un_{i,j}) - q_{i-\half,j}(\un_{i,j}-\un_{i-1,j})\right)
\end{equation}
The corresponding appoximation for $\phi_y$ gives
\begin{equation}
\left[\dy\left(q(x,y) \duy\right)\right]^n_{i,j} \approx \frac{1}{\Dy^2}\left(q_{i,j+\half}(\un_{i,j+1}-\un_{i,j}) - q_{i,j-\half}(\un_{i,j}-\un_{i,j-1})\right)
\end{equation}
Next, we need to be able to compute the coefficient $q$ between the mesh points. To do this, we use the arithmetic average:
\begin{align*}
q_{i+\half,j} &= \half(q_{i,j} + q_{i+1,j}) = [\bar{q}^x]_{i,j}\\
q_{i,j+\half} &= \half(q_{i,j} + q_{i,j+1}) = [\bar{q}^y]_{i,j}
\end{align*}

We can now write the discrete equations compactly using operator notation. The equation becomes:
\begin{equation}
\left[D_tD_tu + bD_tu = D_x\bar{q}^xD_xu + D_y\bar{q}^yD_yu + f\right]^n_{i,j}
\label{op_not}
\end{equation}

\subsection{Boundary conditions}\label{BC_sec}
We have the Neumann boundary condition
\begin{equation*}
\dun = \bn \cdot \nabla u
\end{equation*}

\subsubsection{ $x=0$, $y = y_j$, $t = t^n$:}
 We have that $\bn = \bi$. Discretizing the boundary condition using a centered difference at this boundary gives
\begin{equation*}
\frac{u^n_{-1,j} - u^n_{1,j}}{2\Dx} = 0
\end{equation*}
We can use this to express the ficticious value $u^n_{-1,j}$ (which is outside the mesh):
\begin{equation}
u^n_{-1,j} = u^n_{1,j}
\label{bc_x0}
\end{equation}

\subsubsection{ $x=L_x$, $y = y_j$, $t = t^n$:}
 We have that $\bn = -\bi$. Discretizing the boundary condition using a centered difference at this boundary gives
\begin{equation*}
-\frac{u^n_{L_x-1,j} - u^n_{L_x+1,j}}{2\Dx} = 0
\end{equation*}
We can use this to express the ficticious value $u^n_{L_x+1,j}$ (which is outside the mesh):
\begin{equation}
u^n_{L_x+1,j} = u^n_{L_x-1,j}
\label{bc_xL}
\end{equation}

\subsubsection{ $x=x_i$, $y = 0$, $t = t^n$:}
 We have that $\bn = \bj$. Discretizing the boundary condition using a centered difference at this boundary gives
\begin{equation*}
\frac{u^n_{i,-1} - u^n_{i,1}}{2\Dy} = 0
\end{equation*}
We can use this to express the ficticious value $u^n_{i,-1}$ (which is outside the mesh):
\begin{equation}
u^n_{i,-1} = u^n_{i,1}
\label{bc_y0}
\end{equation}

\subsubsection{ $x=x_i$, $y = L_y$, $t = t^n$:}
 We have that $\bn = -\bj$. Discretizing the boundary condition using a centered difference at this boundary gives
\begin{equation*}
-\frac{u^n_{i,L_y-1} - u^n_{i,L_y+1}}{2\Dy} = 0
\end{equation*}
We can use this to express the ficticious value $u^n_{i,L_y+1}$ (which is outside the mesh):
\begin{equation}
u^n_{i,L_y+1} = u^n_{i,L_y-1}
\label{bc_yL}
\end{equation}


\subsection{Initial conditions}\label{IC_sec}
The equation \eqref{wave_eq} has two initial conditions:
\begin{subequations}\label{IC_grp}
\begin{align}
u(x,y,0) &= I(x,y)\label{IC_1}\\
u_t(x,y,0) &= V(x,y)\label{IC_2}
\end{align}
\end{subequations}
The first IC \eqref{IC_1} is used to set $u^0_{i,j}$ for all the mesh points, i.e.
\[u^0_{i,j} = I(x_i,y_j)\] for $i = 1, 2, ..., (L_x-1)$ and $j = 1, 2, ..., (L_y-1)$.
The second IC \eqref{IC_2} is used to determine $u^{-1}_{i,j}$ . We use the backward difference appriximation for the derivative:
\begin{equation*}
\dut \approx \frac{\un_{i,j} - \unm_{i,j}}{\Dt}
\end{equation*}
At $t = t^n$, this gives
\begin{equation*}
\frac{u^0_{i,j} - u^{-1}_{i,j}}{2\Dt} = V(x,y)
\end{equation*}
This gives us an expression for the ficticious value $u^{-1}_{i,j}$, which is needed to determine the initial condition for all the mesh points.

In the next section, we summarize the findings from this section. 

\section{The scheme}
\subsection{The general scheme for computing $\unp_{i,j}$ at interior spatial mesh points}

Solving equation \eqref{op_not} with respect to $\unp_{i,j}$ gives us the general computational scheme for all interior ($i = 1, ....,(L_x-1)$, $j = 1,....,(L_y-1)$) spatial mesh points:

\begin{align}
\unp_{i,j} = &\frac{1}{\left(1+\frac{b\Dt}{2}\right)}\bigg[ 2\un_{i,j} - \unm_{i,j}\left(1-\frac{b\Dt}{2}\right) +\nonumber\\
&\frac{\Dt^2}{2\Dx^2}\left((q_{i,j} + q_{i+1,j})(\un_{i+1,j}-\un_{i,j}) - (q_{i-1,j} + q_{i,j})(\un_{i,j}-\un_{i-1,j})\right) + \nonumber\\
&\frac{\Dt^2}{2\Dy^2}\left((q_{i,j} + q_{i,j+1})(\un_{i,j+1}-\un_{i,j}) - (q_{i,j-1} + q_{i,j})(\un_{i,j}-\un_{i,j-1})\right) +\nonumber\\
&f(x_i, y_j, t^n)\bigg]
\end{align}


This scheme requires the current ($n$) and previous ($n-1$) time steps in order to compute the next ($n+1$) time step. 

\subsection{The modified scheme at boundary points}
At the boundary points, we replace the ficticious values that appear with the values calculated in section \ref{BC_sec}.
\subsubsection{$x=0$, $y=y_j$, $t = t^n$}
\textbf{NOTE: FIND OUT WHAT TO DO WITH $q_{-1,j}$!}
In this case, we replace $\un_{-1,j}$ with $\un_{1,j}$.
\begin{align}
\unp_{0,j} = &\frac{1}{\left(1+\frac{b\Dt}{2}\right)}\bigg[ 2\un_{0,j} - \unm_{0,j}\left(1-\frac{b\Dt}{2}\right) +\nonumber\\
&\frac{\Dt^2}{2\Dx^2}\left((q_{0,j} + q_{1,j})(\un_{1,j}-\un_{0,j}) - (q_{i-1,j} + q_{0,j})(\un_{0,j}-\un_{1,j})\right) + \nonumber\\
&\frac{\Dt^2}{2\Dy^2}\left((q_{0,j} + q_{0,j+1})(\un_{0,j+1}-\un_{0,j}) - (q_{0,j-1} + q_{0,j})(\un_{0,j}-\un_{0,j-1})\right) +\nonumber\\
&f(x_0, y_j, t^n)\bigg]
\end{align}
To make sure that the BC are correct also on the corners, we can do a test. If $j = 0$ or $j=L_y$, we have to replace the occurences of $\un_{0,-1}$ and $\un_{0,L_y+1}$ with $\un_{0,1}$ and $\un_{0,L_y-1}$ respectively. In a program, this can be done with a simple \textit{if-test}.

\subsubsection{$x=L_x$, $y=y_j$, $t = t^n$}
\textbf{NOTE: FIND OUT WHAT TO DO WITH $q_{L_x+1,j}$!}
In this case, we replace $\un_{L_x+1,j}$ with $\un_{L_x-1,j}$.
\begin{align}
\unp_{L_x,j} = &\frac{1}{\left(1+\frac{b\Dt}{2}\right)}\bigg[ 2\un_{L_x,j} - \unm_{L_x,j}\left(1-\frac{b\Dt}{2}\right) +\nonumber\\
&\frac{\Dt^2}{2\Dx^2}\left((q_{L_x,j} + q_{L_x+1,j})(\un_{L_x-1,j}-\un_{L_x,j}) - (q_{L_x-1,j} + q_{L_x,j})(\un_{L_x,j}-\un_{L_x-1,j})\right) + \nonumber\\
&\frac{\Dt^2}{2\Dy^2}\left((q_{L_x,j} + q_{L_x,j+1})(\un_{L_x,j+1}-\un_{L_x,j}) - (q_{L_x,j-1} + q_{L_x,j})(\un_{L_x,j}-\un_{L_x,j-1})\right) +\nonumber\\
&f(x_{L_x}, y_j, t^n)\bigg]
\end{align}
Again, to make sure that the BC are correct also on the corners, we can do a test. If $j = 0$ or $j=L_y$, we have to replace the occurences of $\un_{L_x,-1}$ and $\un_{L_x,L_y+1}$ with $\un_{L_x,1}$ and $\un_{L_y,L_y-1}$ respectively. In a program, this can be done with a simple \textit{if-test}.

\subsubsection{$x=x_i$, $y=0$, $t=t^n$}
Since we have tested to make sure the corners are correct already, we let $i=1,...,(L_x-1)$.
In this case, we replace $\un_{i,-1}$ with $\un_{i,1}$.
\begin{align}
\unp_{i,0} = &\frac{1}{\left(1+\frac{b\Dt}{2}\right)}\bigg[ 2\un_{i,0} - \unm_{i,0}\left(1-\frac{b\Dt}{2}\right) +\nonumber\\
&\frac{\Dt^2}{2\Dx^2}\left((q_{i,0} + q_{i+1,0})(\un_{i+1,0}-\un_{i,0}) - (q_{i-1,0} + q_{i,0})(\un_{i,0}-\un_{i-1,0})\right) + \nonumber\\
&\frac{\Dt^2}{2\Dy^2}\left((q_{i,0} + q_{i,1})(\un_{i,1}-\un_{i,0}) - (q_{i,j-1} + q_{i,0})(\un_{i,0}-\un_{i,1})\right) +\nonumber\\
&f(x_i, y_0, t^n)\bigg]
\end{align}

\subsubsection{$x=x_i$, $y=L_y$, $t=t^n$}
Again, since we have tested to make sure the corners are correct already, we let $i=1,...,(L_x-1)$.
In this case, we replace $\un_{i,L_y+1}$ with $\un_{i,L_y-1}$.
\begin{align}
\unp_{i,L_y} = &\frac{1}{\left(1+\frac{b\Dt}{2}\right)}\bigg[ 2\un_{i,L_y} - \unm_{i,L_y}\left(1-\frac{b\Dt}{2}\right) +\nonumber\\
&\frac{\Dt^2}{2\Dx^2}\left((q_{i,L_y} + q_{i+1,L_y})(\un_{i+1,L_y}-\un_{i,L_y}) - (q_{i-1,L_y} + q_{i,L_y})(\un_{i,L_y}-\un_{i-1,L_y})\right) + \nonumber\\
&\frac{\Dt^2}{2\Dy^2}\left((q_{i,L_y} + q_{i,L_y-1})(\un_{i,L_y-1}-\un_{i,L_y}) - (q_{i,L_y-1} + q_{i,L_y})(\un_{i,L_y}-\un_{i,L_y-1})\right) +\nonumber\\
&f(x_i, y_{L_y}, t^n)\bigg]
\end{align}


\subsection*{The modified scheme for the first step at interior points}
Here, we use \eqref{IC_1} for $i = 1, 2, ..., (L_x-1)$ and $j = 1, 2, ..., (L_y-1)$, as stated earlier, and the modified scheme for the first time step becomes
\begin{equation}
u^0_{i,j} = I(x,y) \label{interior_IC}
\end{equation}


\subsection*{The modified scheme for the first step at boundary points}
At the boundary points, the modified scheme for the first step is a little more complicated, as we have to take into consideration the boundary conditions as well. From section \ref{IC_sec} we have an expression for $u^{-1}_{i,j}$:
\[u^{-1}_{i,j} = u^0_{i,j} - \Dt V(x,y)\]







\end{document}
